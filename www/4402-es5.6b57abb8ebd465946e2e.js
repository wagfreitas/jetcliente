!function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}(self.webpackChunkdriver=self.webpackChunkdriver||[]).push([[4402],{2401:function(t,n,o){"use strict";o.r(n),o.d(n,{HomePageModule:function(){return A}});var r=o(8583),s=o(3679),a=o(2859),c=o(3025),l=o(9019),h=o(5257),u=o(7716),d=o(7234),p=o(7152),g=o(4207),v=o(9997),m=o(4050),f=o(9829),x=o(7556),y=o(5469),S=o(7318),k=function(){var t=function(){function t(i,n){e(this,t),this.db=i,this.authService=n}return i(t,[{key:"sortDriversList",value:function(e){return e.sort(function(e,t){return e.rating-e.distance/5-(t.rating-t.distance/5)})}},{key:"makeDeal",value:function(e,t,i,n,o,r,s,a,c,h,u,d,p,g,v,m,f){return this.db.object("deals/"+t).set({passengerId:e,currency:s,origin:i,destination:n,distance:o,fee:r,note:a,paymentMethod:c,status:l.MN,createdAt:Date.now(),promocode:h,discount:u,tax:d,fee_taxed:p,rawfee:g,commission_type:v,commission_value:m,commission:f})}},{key:"getDriverDeal",value:function(e){return this.db.object("deals/"+e)}},{key:"removeDeal",value:function(e){return this.db.object("deals/"+e).remove()}}]),t}();return t.\u0275fac=function(e){return new(e||t)(u.LFG(S.KQ),u.LFG(x.e))},t.\u0275prov=u.Yz7({token:t,factory:t.\u0275fac,providedIn:"root"}),t}(),b=o(5620);function C(e,t){if(1&e&&(u.TgZ(0,"span"),u._uU(1),u.qZA()),2&e){var i=u.oxw();u.xp6(1),u.Oqu(i.distanceText)}}function D(e,t){if(1&e&&(u.TgZ(0,"span"),u._uU(1),u.qZA()),2&e){var i=u.oxw();u.xp6(1),u.hij("\xa0 ",i.durationText,"")}}var M=function(e){return{active:e}};function w(e,t){if(1&e){var i=u.EpF();u.TgZ(0,"ion-col",16),u.NdJ("click",function(){var e=u.CHM(i).index;return u.oxw().chooseVehicle(e)}),u.TgZ(1,"p",17),u._uU(2),u.qZA(),u._UZ(3,"img",18),u.TgZ(4,"p",19),u._uU(5),u.qZA(),u.qZA()}if(2&e){var n=t.$implicit,o=u.oxw();u.Q6J("ngClass",u.VKq(5,M,n.active)),u.xp6(2),u.Oqu(n.name),u.xp6(1),u.s9C("src",n.icon,u.LSH),u.xp6(2),u.AsE("",o.currency,"",n.fee_taxed,"")}}var _,P,T=function(){return{height:"100%"}},Z=[{path:"",component:(_=function(){function t(i,n,o,r,s,a,c,l,h,u,d,p,g,v,m){e(this,t),this.router=i,this.alertCtrl=n,this.placeService=o,this.geolocation=r,this.chRef=s,this.settingService=a,this.tripService=c,this.driverService=l,this.afAuth=h,this.authService=u,this.translate=d,this.dealService=p,this.common=g,this.menuCtrl=v,this.db=m,this.mapId=Math.random()+"map",this.mapHeight=480,this.showModalBg=!1,this.showVehicles=!1,this.vehicles=[],this.note="",this.promocode="",this.distance=0,this.duration=0,this.paymentMethod="dinheiro",this.activeDrivers=[],this.driverMarkers=[],this.locateDriver=!1,this.user={},this.isTrackDriverEnabled=!0,this.discount=0,this.settings={},this.distanceText="",this.durationText=""}return i(t,[{key:"ionViewDidEnter",value:function(){var e=this;this.menuCtrl.enable(!0),this.afAuth.authState.subscribe(function(t){null!=t&&e.authService.getUser(t.uid).snapshotChanges().subscribe(function(t){e.user=Object.assign({key:t.key,uid:t.key},t.payload.val())})}),this.settingService.getSettings().subscribe(function(t){return e.settings=null!=t?t.payload.val():{}}),this.origin=this.tripService.getOrigin(),this.destination=this.tripService.getDestination(),this.loadMap()}},{key:"ngOnInit",value:function(){}},{key:"ionViewDidLeave",value:function(){clearInterval(this.driverTracking)}},{key:"getPaymentMethod",value:function(){return this.paymentMethod=this.tripService.getPaymentMethod(),this.paymentMethod}},{key:"choosePaymentMethod1",value:function(){var e=this;this.alertCtrl.create({header:"Selecione a forma de pagamento",inputs:[{type:"radio",label:"Card",value:"card"}],buttons:[{text:"Cancela"},{text:"Seleciona",handler:function(t){console.log(t),"card"==t?e.authService.getCardSetting(e.user.uid).valueChanges().pipe((0,h.q)(1)).subscribe(function(i){if(null!=i){e.tripService.setPaymentMethod(t),e.paymentMethod=t;var n=i.exp.split("/");Stripe.card.createToken({number:i.number,exp_month:n[0],exp_year:n[1],cvc:i.cvv},function(t,n){200==t?(console.log("Card Ready"),e.authService.updateCardSetting(i.number,i.exp,i.cvv,n.id,e.user.uid)):e.common.showToast(n.error.message)})}else e.common.showAlert("Cart\xe3o Inv\xe1lido")}):"cash"==t&&(e.paymentMethod=t,e.tripService.setPaymentMethod(t))}}]}).then(function(e){return e.present()})}},{key:"chooseVehicle",value:function(e){for(var t=0;t<this.vehicles.length;t++)this.vehicles[t].active=t==e,t==e&&(this.tripService.setVehicle(this.vehicles[t]),this.currentVehicle=this.vehicles[t]);this.trackDrivers(),this.toggleVehicles()}},{key:"loadMap",value:function(){var e=this;return this.geolocation.getCurrentPosition().then(function(t){var i;e.startLatLng=e.origin?new google.maps.LatLng(e.origin.location.lat,e.origin.location.lng):new google.maps.LatLng(t.coords.latitude,t.coords.longitude);var n=new google.maps.DirectionsService;i=new google.maps.DirectionsRenderer({polylineOptions:{strokeColor:"black"}});var o=l.NZ.mapOptions;o.center=e.startLatLng,o.mapTypeId=google.maps.MapTypeId.ROADMAP,e.map=new google.maps.Map(document.getElementById(e.mapId),o);var r=e.map;if(i.setMap(r),(new google.maps.Geocoder).geocode({latLng:e.map.getCenter()},function(t,i){if(i==google.maps.GeocoderStatus.OK){e.origin?e.setOrigin():(e.origin=e.placeService.formatAddress(t[0]),e.tripService.setOrigin(e.origin.vicinity,e.origin.location.lat,e.origin.location.lng),e.setOrigin(),e.chRef.detectChanges());var o=e.placeService.setLocalityFromGeocoder(t);e.settingService.getPrices().valueChanges().subscribe(function(t){e.vehicles=[];var i=t[o]?t[o]:t.default;e.currency=e.settings.currency,e.tripService.setCurrency(e.settings.currency),Object.keys(i.vehicles).forEach(function(t){i.vehicles[t].id=t,e.vehicles.push(i.vehicles[t])}),console.log("veiculos",e.vehicles),e.destination&&n.route(a,function(t,i){if(i==google.maps.DirectionsStatus.OK&&0!=t.routes.length){console.log(t),e.distance=t.routes[0].legs[0].distance.value/1e3,e.distanceText=t.routes[0].legs[0].distance.text,e.durationText=t.routes[0].legs[0].duration.text,console.log(e.distance);for(var n=0;n<e.vehicles.length;n++){if(e.distance<=parseInt(e.vehicles[n].base_km)){var o=parseFloat((e.distance*parseInt(e.vehicles[n].base_fare)).toFixed(2));e.vehicles[n].fee=o,e.vehicles[n].fee_taxed=parseFloat((o+o*(parseInt(e.vehicles[n].tax)/100)).toFixed(2))}else if(e.distance>parseInt(e.vehicles[n].base_km)){var r=e.distance-parseInt(e.vehicles[n].base_km),s=parseFloat((parseInt(e.vehicles[n].base_km)*parseInt(e.vehicles[n].base_fare)+r*parseInt(e.vehicles[n].per_km)).toFixed(2));e.vehicles[n].fee=s,e.vehicles[n].fee_taxed=parseFloat((s+s*(parseInt(e.vehicles[n].tax)/100)).toFixed(2))}e.vehicles[n].commission="percentage"==e.vehicles[n].commission_type?parseFloat((e.vehicles[n].fee*(parseInt(e.vehicles[n].commission_value)/100)).toFixed(2)):parseFloat(parseFloat(e.vehicles[n].commission_value).toFixed(2))}}else console.log("error")}),e.vehicles[0].active=!0,e.currentVehicle=e.vehicles[0],e.locality=o,e.isTrackDriverEnabled&&e.trackDrivers()})}}),e.destination){e.destLatLng=new google.maps.LatLng(e.destination.location.lat,e.destination.location.lng);var s=new google.maps.LatLngBounds;s.extend(e.startLatLng),s.extend(e.destLatLng),r.fitBounds(s);var a={origin:e.startLatLng,destination:e.destLatLng,travelMode:google.maps.TravelMode.DRIVING};n.route(a,function(e,t){t==google.maps.DirectionsStatus.OK?(console.log(e),i.setDirections(e),i.setMap(r)):console.log("error")})}}).catch(function(e){console.log("Error getting location",e)})}},{key:"showPromoPopup",value:function(){var e=this;this.alertCtrl.create({header:"Enter Promo code",inputs:[{name:"promocode",placeholder:"Enter Promo Code",value:this.promocode}],buttons:[{text:"Cancel"},{text:"Apply",handler:function(t){console.log(t.promocode);var i=t.promocode.toUpperCase();e.db.list("promocodes",function(e){return e.orderByChild("code").equalTo(i)}).snapshotChanges().pipe((0,h.q)(1)).subscribe(function(t){if(console.log(t),t.length>0){var i=t[0].payload.val();e.promocode=i.code,e.discount=i.discount,e.tripService.setPromo(i.code),e.tripService.setDiscount(i.discount),e.common.showToast(i.code+" Applied with "+i.discount+"% discount")}else e.common.showToast("Invalid Promocode")})}}]}).then(function(e){return e.present()})}},{key:"showNotePopup",value:function(){var e=this;this.alertCtrl.create({header:"Dicas para o T\xe9cnico",message:"",inputs:[{name:"note",placeholder:"Dicas"}],buttons:[{text:"Cancela"},{text:"Salva",handler:function(t){e.note=t,e.tripService.setNote(t),console.log("Saved clicked")}}]}).then(function(e){return e.present()})}},{key:"book",value:function(){if(this.locateDriver=!0,this.tripService.setAvailableDrivers(this.activeDrivers),this.tripService.setDistance(this.distance),this.tripService.setFee(this.currentVehicle.fee),this.tripService.setRawFee(this.currentVehicle.fee),this.tripService.setFeeTaxed(this.currentVehicle.fee_taxed),this.tripService.setIcon(this.currentVehicle.icon),this.tripService.setNote(this.note),this.tripService.setPromo(this.promocode),this.tripService.setDiscount(this.discount),this.tripService.setTax(this.currentVehicle.tax),this.tripService.setCommissionType(this.currentVehicle.commission_type),this.tripService.setCommissionValue(this.currentVehicle.commission_value),this.tripService.setCommission(this.currentVehicle.commission),this.drivers=this.tripService.getAvailableDrivers(),this.drivers=this.dealService.sortDriversList(this.drivers),console.log(this.tripService.getDiscount()),0!=this.tripService.getDiscount()){console.log(this.tripService.getFee());var e=this.tripService.getFee()-this.tripService.getFee()*this.tripService.getDiscount()/100;this.tripService.setFee(parseFloat(e.toFixed(2))),console.log(e.toFixed(2));var t=e+e*(this.tripService.getTax()/100);this.tripService.setFeeTaxed(parseFloat(t.toFixed(2))),console.log(t.toFixed(2))}this.drivers&&this.makeDeal(0)}},{key:"makeDeal",value:function(e){var t=this,i=this.drivers[e];i?(i.status="Bidding",this.dealService.getDriverDeal(i.key).valueChanges().pipe((0,h.q)(1)).subscribe(function(n){console.log(n),null==n?(console.log(n),console.log(t.user),t.dealService.makeDeal(t.user.uid,i.key,t.tripService.getOrigin(),t.tripService.getDestination(),t.tripService.getDistance(),t.tripService.getFee(),t.tripService.getCurrency(),t.tripService.getNote(),t.tripService.getPaymentMethod(),t.tripService.getPromo(),t.tripService.getDiscount(),t.tripService.getTax(),t.tripService.getFeeTaxed(),t.tripService.getRawFee(),t.tripService.getCommissionType(),t.tripService.getCommissionValue(),t.tripService.getCommission()).then(function(){var n=t.dealService.getDriverDeal(i.key).valueChanges().subscribe(function(i){null!==i&&i.status==l.MN||(n.unsubscribe(),null===i?t.nextDriver(e):i.status==l.je&&(console.log("accepted",i.tripId),t.locateDriver=!1,t.drivers=[],t.tripService.setId(i.tripId),t.router.navigateByUrl("tracking")))})})):t.nextDriver(e)})):(console.log("No user found"),this.locateDriver=!1,this.common.showAlert("Nenhum t\xe9cnico encontrado ou t\xe9cnicos est\xe3o longe do seu endere\xe7o "))}},{key:"nextDriver",value:function(e){this.drivers.splice(e,1),this.makeDeal(e)}},{key:"chooseOrigin",value:function(){this.router.navigate(["map"],{queryParams:{type:"origin"}})}},{key:"chooseDestination",value:function(){this.router.navigate(["map"],{queryParams:{type:"destination"}})}},{key:"choosePaymentMethod",value:function(){this.router.navigateByUrl("/payments")}},{key:"setOrigin",value:function(){var e=new google.maps.LatLng(this.origin.location.lat,this.origin.location.lng),t=new google.maps.Marker({map:this.map,position:e});t.setMap(this.map),this.destination&&t.setMap(null),this.map.setCenter(e)}},{key:"toggleVehicles",value:function(){this.showVehicles=!this.showVehicles,this.showModalBg=1==this.showVehicles}},{key:"trackDrivers",value:function(){var e=this;this.showDriverOnMap(this.locality),clearInterval(this.driverTracking),this.driverTracking=setInterval(function(){e.showDriverOnMap(e.locality)},l.YL)}},{key:"showDriverOnMap",value:function(e){var t=this;console.log("Searching: "+this.currentVehicle.id+" under "+e),this.driverService.getActiveDriver(e,this.currentVehicle.id).valueChanges().pipe((0,h.q)(1)).subscribe(function(e){t.clearDrivers(),null!=e&&(console.log(e.length+" Drivers"),e.forEach(function(e){var i=t.placeService.calcCrow(e.lat,e.lng,t.origin.location.lat,t.origin.location.lng);if(console.log("Distancia:"+(i<l.Wt)+" \xfaltima atividade:"+(e.last_active<l.lI)),i<l.Wt&&Date.now()-e.last_active<l.lI){var n=new google.maps.LatLng(e.lat,e.lng),o=new google.maps.Marker({map:t.map,position:n,icon:{url:t.currentVehicle.map_icon,size:new google.maps.Size(32,32),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(16,16),scaledSize:new google.maps.Size(32,32)}});e.distance=i,t.driverMarkers.push(o),t.activeDrivers.push(e)}else console.log("Esse veiculo esta muito longe")}))})}},{key:"clearDrivers",value:function(){this.activeDrivers=[],this.driverMarkers.forEach(function(e){e.setMap(null)})}}]),t}(),_.\u0275fac=function(e){return new(e||_)(u.Y36(c.F0),u.Y36(a.Br),u.Y36(d.k),u.Y36(p.b),u.Y36(u.sBO),u.Y36(g.R),u.Y36(v.a),u.Y36(m.F),u.Y36(f.zQ),u.Y36(x.e),u.Y36(y.sK),u.Y36(k),u.Y36(b.v),u.Y36(a._q),u.Y36(S.KQ))},_.\u0275cmp=u.Xpm({type:_,selectors:[["app-home"]],decls:32,vars:19,consts:[["color","dark"],["slot","start"],[1,"locationinput-holder"],["placeholder","local do atendimento?","type","text",1,"locationinput",3,"value","click"],[1,"distanceText",3,"hidden"],[4,"ngIf"],[3,"id","ngStyle"],[2,"padding","8px"],[2,"background","#f5f5f5",3,"hidden"],["fill","clear","size","small","color","dark","expand","block",3,"click"],["slot","start",3,"name"],["slot","start","name","create"],[3,"hidden"],[3,"ngClass","click",4,"ngFor","ngForOf"],["expand","block","color","dark",3,"hidden","click"],["name","dots","color","light",3,"hidden"],[3,"ngClass","click"],[1,"carName"],[3,"src"],[1,"carPrice"]],template:function(e,t){1&e&&(u.TgZ(0,"ion-header"),u.TgZ(1,"ion-toolbar",0),u.TgZ(2,"ion-buttons",1),u._UZ(3,"ion-menu-button"),u.qZA(),u.TgZ(4,"ion-title"),u._uU(5," JetPort "),u.qZA(),u.qZA(),u.qZA(),u.TgZ(6,"ion-content"),u.TgZ(7,"div",2),u.TgZ(8,"input",3),u.NdJ("click",function(){return t.chooseOrigin()}),u.qZA(),u.TgZ(9,"p",4),u.YNc(10,C,2,1,"span",5),u.YNc(11,D,2,1,"span",5),u.qZA(),u.qZA(),u._UZ(12,"div",6),u.qZA(),u.TgZ(13,"ion-footer"),u.TgZ(14,"ion-toolbar",7),u.TgZ(15,"ion-row",8),u.TgZ(16,"ion-col"),u.TgZ(17,"ion-button",9),u.NdJ("click",function(){return t.choosePaymentMethod1()}),u._UZ(18,"ion-icon",10),u._uU(19),u.qZA(),u.qZA(),u.TgZ(20,"ion-col"),u.TgZ(21,"ion-button",9),u.NdJ("click",function(){return t.showPromoPopup()}),u._UZ(22,"ion-icon",11),u._uU(23),u.ALo(24,"translate"),u.qZA(),u.qZA(),u.qZA(),u.TgZ(25,"ion-row",12),u.YNc(26,w,6,7,"ion-col",13),u.qZA(),u.TgZ(27,"ion-button",14),u.NdJ("click",function(){return t.chooseDestination()}),u._uU(28," Acionar T\xe9cnico"),u.qZA(),u.TgZ(29,"ion-button",14),u.NdJ("click",function(){return t.book()}),u._uU(30),u._UZ(31,"ion-spinner",15),u.qZA(),u.qZA(),u.qZA()),2&e&&(u.xp6(8),u.s9C("value",t.origin?t.origin.vicinity:""),u.xp6(1),u.Q6J("hidden",!t.destination),u.xp6(1),u.Q6J("ngIf",""!=t.distanceText),u.xp6(1),u.Q6J("ngIf",""!=t.durationText),u.xp6(1),u.s9C("id",t.mapId),u.Q6J("ngStyle",u.DdM(18,T)),u.xp6(3),u.Q6J("hidden",!t.destination),u.xp6(3),u.s9C("name",t.getPaymentMethod()),u.xp6(1),u.hij(" ",t.getPaymentMethod()," "),u.xp6(4),u.hij(" ",u.lcZ(24,16,"PROMO")," "),u.xp6(2),u.Q6J("hidden",!t.destination),u.xp6(1),u.Q6J("ngForOf",t.vehicles),u.xp6(1),u.Q6J("hidden",t.origin),u.xp6(2),u.Q6J("hidden",!t.origin),u.xp6(1),u.hij(" ",0==t.locateDriver?"Acionar T\xe9cnico":"Localizando T\xe9cnico"," "),u.xp6(1),u.Q6J("hidden",!t.locateDriver))},directives:[a.Gu,a.sr,a.Sm,a.fG,a.wd,a.W2,r.O5,r.PC,a.fr,a.Nd,a.wI,a.YG,a.gu,r.sg,a.PQ,r.mk],pipes:[y.X$],styles:["ion-title[_ngcontent-%COMP%]{text-align:center;margin-left:-40px!important;letter-spacing:4px}.header-md[_ngcontent-%COMP%]:after{background:none}.locationinput-holder[_ngcontent-%COMP%]{padding:.2rem 1rem;background:#222;top:0;width:100%}.locationinput[_ngcontent-%COMP%]{background:#fff;outline:0;width:100%;padding:.5rem;margin:2px 0;font-size:14px;border-radius:4px;border:none;color:#555}.distanceText[_ngcontent-%COMP%]{font-size:12px;color:#eee;margin:0}.align-bottom[_ngcontent-%COMP%]{position:fixed;bottom:0;width:100%;padding:5px}.align-bottom[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:14p}ion-col[_ngcontent-%COMP%]{text-align:center;display:flex;flex-direction:column;justify-content:center;align-items:center}ion-col[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:40px;height:40px;padding:4px;border-radius:100%}ion-col[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:2px}ion-row[_ngcontent-%COMP%]{background:#fff}.list-md[_ngcontent-%COMP%]{margin:-1px 0 0}.label-md[_ngcontent-%COMP%]{margin:13px -50px 13px 0}.text-input-md[_ngcontent-%COMP%]{font-size:14px;margin:8px 5px}#map[_ngcontent-%COMP%]{width:100%}.active[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{border:3px solid #ffce00}.carName[_ngcontent-%COMP%]{font-size:12px;display:inline-block;background:#333;color:#fff;padding:2px 4px;border-radius:4px}.carSeats[_ngcontent-%COMP%]{color:#777;font-size:.7em}.carPrice[_ngcontent-%COMP%]{color:#777;font-size:.8em}"]}),_)}],O=function(){var t=i(function t(){e(this,t)});return t.\u0275fac=function(e){return new(e||t)},t.\u0275mod=u.oAB({type:t}),t.\u0275inj=u.cJS({imports:[[c.Bz.forChild(Z)],c.Bz]}),t}(),A=((P=i(function t(){e(this,t)})).\u0275fac=function(e){return new(e||P)},P.\u0275mod=u.oAB({type:P}),P.\u0275inj=u.cJS({imports:[[r.ez,s.u5,a.Pc,y.aw,O]]}),P)}}])}();